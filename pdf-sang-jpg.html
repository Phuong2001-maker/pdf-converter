<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF sang JPG — Chuyển đổi trực tuyến</title>
  <meta name="description" content="Chuyển đổi nhiều tệp PDF sang JPG ngay trên trình duyệt. Kéo thả, xem trước và tải về ảnh JPG chất lượng cao." />
  <meta name="robots" content="index,follow" />
  <meta property="og:title" content="PDF sang JPG — Công cụ chuyển đổi ảnh" />
  <meta property="og:description" content="Tách trang PDF thành ảnh JPG sắc nét, hỗ trợ xử lý hàng loạt và tải xuống nhanh chóng." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://pdf-converter.tools/pdf-sang-jpg" />
  <meta property="og:locale" content="vi_VN" />
  <meta property="og:site_name" content="PDF Converter Tools" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="PDF sang JPG — Chuyển đổi trực tuyến" />
  <meta name="twitter:description" content="Chuyển đổi PDF sang JPG chất lượng cao, thao tác đơn giản với kéo thả." />
  <link rel="canonical" href="https://pdf-converter.tools/pdf-sang-jpg" />
  <link rel="alternate" href="https://pdf-converter.tools/pdf-sang-jpg" hreflang="vi" />
  <link rel="alternate" href="https://pdf-converter.tools/pdf-sang-jpg" hreflang="x-default" />
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "PDF sang JPG",
    "applicationCategory": "MultimediaApplication",
    "operatingSystem": "Any",
    "description": "Công cụ chuyển đổi PDF sang ảnh JPG trực tuyến, hỗ trợ xử lý nhiều tệp và tải xuống dạng ZIP.",
    "url": "https://pdf-converter.tools/pdf-sang-jpg",
    "offers": {
      "@type": "Offer",
      "price": "0.00",
      "priceCurrency": "USD"
    }
  }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f5f9;
      --surface:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --primary:#e53935;
      --primary-dark:#c62828;
      --ring:rgba(229,57,53,.3);
      --shadow:0 20px 40px rgba(17,24,39,.09), 0 10px 20px rgba(17,24,39,.05);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);}

    .app{display:grid;grid-template-columns:1fr 360px;gap:28px;min-height:100vh;padding:28px;}
    @media (max-width:1100px){
      .app{grid-template-columns:1fr;padding:16px 16px 90px;gap:16px;}
    }

    .board{background:linear-gradient(180deg,#f7f8fc 0%,#f3f4f8 100%);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;display:flex;flex-direction:column;gap:24px;position:relative;overflow:hidden;}
    @media (max-width:600px){.board{padding:20px;}}

    .dropzone{border:2px dashed #e5e7eb;border-radius:22px;background:rgba(255,255,255,.9);backdrop-filter:blur(3px);padding:60px 30px;text-align:center;color:#4b5563;display:flex;flex-direction:column;align-items:center;gap:14px;transition:border-color .2s,box-shadow .2s,transform .2s;background-image:linear-gradient(135deg,rgba(229,57,53,.08),rgba(255,255,255,0));}
    .dropzone.dragover{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring);transform:translateY(-2px);}
    .dropzone.disabled{opacity:.55;pointer-events:none;}
    .dropzone.disabled button{cursor:not-allowed;background:#d1d5db;color:#6b7280;box-shadow:none;}
    .dropzone strong{font-size:20px;font-weight:700;color:#1f2937;}
    .dropzone button{background:var(--primary);color:#fff;border:none;border-radius:14px;padding:14px 20px;font-weight:600;cursor:pointer;box-shadow:0 12px 24px rgba(229,57,53,.25);transition:background .2s,transform .2s;}
    .dropzone button:hover{background:var(--primary-dark);transform:translateY(-1px);}    

    .selection-bar{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.85);border-radius:16px;padding:14px 18px;font-weight:600;color:#1f2937;box-shadow:0 12px 24px rgba(17,24,39,.06);backdrop-filter:blur(2px);}
    .selection-bar span{color:var(--muted);font-weight:500;}
    .clear-btn{border:none;background:transparent;color:var(--primary);font-weight:600;cursor:pointer;}
    .clear-btn:hover{text-decoration:underline;}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px;}
    .card{background:var(--surface);border-radius:16px;box-shadow:0 10px 30px rgba(17,24,39,.1);padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;transition:transform .18s ease,box-shadow .18s ease;}
    .card:hover{transform:translateY(-4px);box-shadow:0 14px 36px rgba(17,24,39,.14);}    
    .thumb{width:100%;aspect-ratio:3/4;border-radius:13px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
    .thumb img{width:100%;height:100%;object-fit:contain;}
    .thumb::after{content:attr(data-pages);position:absolute;bottom:10px;right:10px;background:rgba(17,24,39,.82);color:#fff;font-size:12px;font-weight:600;padding:4px 8px;border-radius:999px;}
    .filename{font-size:13px;font-weight:600;color:#1f2937;text-align:center;word-break:break-word;line-height:1.35;}
    .remove{position:absolute;top:10px;right:10px;border:none;background:#fff;color:#ef4444;border-radius:10px;padding:6px 9px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(239,68,68,.35);} 
    .empty{border:1px dashed #d1d5db;border-radius:16px;padding:28px 18px;text-align:center;color:#9ca3af;font-size:14px;}

    .rightpanel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:26px;display:flex;flex-direction:column;gap:22px;position:sticky;top:26px;align-self:flex-start;}
    .rightpanel h2{margin:0;font-size:22px;font-weight:700;}
    .rightpanel p{margin:0;color:var(--muted);line-height:1.5;font-size:14px;}

    .mode-card{display:flex;align-items:center;gap:16px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 12px 32px rgba(17,24,39,.08);}
    .mode-card .icon{font-size:34px;line-height:1;}
    .mode-card strong{display:block;font-size:16px;color:#1f2937;margin-bottom:4px;}
    .mode-card p{margin:0;font-size:14px;color:var(--muted);line-height:1.5;}

    .quality{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
    @media (max-width:600px){.quality{grid-template-columns:1fr;}}
    .qitem{display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;gap:10px;min-height:140px;padding:18px;border-radius:18px;background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 8px 18px rgba(15,23,42,.07);cursor:pointer;transition:transform .18s ease,box-shadow .22s ease,border-color .22s ease,background .22s ease;}
    .qitem strong{font-size:17px;color:#1f2937;line-height:1.25;font-weight:600;}
    .qitem small{font-size:13px;font-weight:500;color:#475569;letter-spacing:.01em;}
    .qitem .badge{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;padding:5px 12px;border-radius:999px;background:#eef2ff;color:#3b82f6;}
    .qitem[data-quality="high"] .badge{background:#ecfdf5;color:#0f766e;}
    .qitem[data-quality="ultra"] .badge{background:#fef2f2;color:#dc2626;}
    .qitem.active{background:linear-gradient(180deg,#fff7f7 0%,#ffe6e6 100%);border-color:rgba(229,57,53,.6);box-shadow:0 20px 36px rgba(229,57,53,.18);transform:translateY(-2px);}
    .qitem.active strong{color:var(--primary-dark);}
    .qitem.active small{color:#991b1b;}
    .qitem:focus-visible{outline:none;box-shadow:0 0 0 4px rgba(229,57,53,.22);}

    .output-format{margin:18px 0 20px;}
    .output-format strong{display:block;margin-bottom:10px;font-size:15px;color:#1f2937;}
    .output-format .options{display:flex;gap:12px;}
    .output-format button{flex:1;padding:14px;border-radius:14px;border:1px solid #e2e8f0;background:#fff;box-shadow:0 8px 18px rgba(15,23,42,.06);font-weight:600;color:#1f2937;cursor:pointer;transition:transform .18s,box-shadow .22s,border-color .22s;background-image:linear-gradient(135deg,rgba(229,57,53,.06),rgba(255,255,255,0));}
    .output-format button.active{border-color:var(--primary);box-shadow:0 0 0 4px rgba(229,57,53,.15);color:var(--primary);transform:translateY(-2px);}
    .output-format button:focus-visible{outline:3px solid var(--ring);outline-offset:2px;}
    @media (max-width:600px){
      .output-format .options{flex-direction:column;}
    }

    .pdf-options{display:none;margin:0 0 20px;}
    .pdf-options strong{display:block;margin-bottom:10px;font-size:15px;color:#1f2937;}
    .pdf-options .options{display:flex;gap:12px;}
    .pdf-options button{flex:1;padding:14px;border-radius:14px;border:1px solid #e2e8f0;background:#fff;box-shadow:0 8px 18px rgba(15,23,42,.06);font-weight:600;color:#1f2937;cursor:pointer;transition:transform .18s,box-shadow .22s,border-color .22s;background-image:linear-gradient(135deg,rgba(229,57,53,.06),rgba(255,255,255,0));}
    .pdf-options button.active{border-color:var(--primary);box-shadow:0 0 0 4px rgba(229,57,53,.15);color:var(--primary);transform:translateY(-2px);}
    .pdf-options button:disabled{cursor:not-allowed;opacity:.55;box-shadow:none;}
    .pdf-options button:focus-visible{outline:3px solid var(--ring);outline-offset:2px;}
    @media (max-width:600px){
      .pdf-options .options{flex-direction:column;}
    }

    .status{border-radius:16px;padding:14px 16px;font-size:13px;line-height:1.6;display:none;box-shadow:0 12px 30px rgba(15,23,42,.08);border:1px solid transparent;margin-bottom:18px;}
    .status.show{display:block;}
    .status.info{background:#eef2ff;color:#312e81;border-color:#c7d2fe;}
    .status.success{background:#ecfdf5;color:#047857;border-color:#bbf7d0;}
    .status.warn{background:#fff7ed;color:#b45309;border-color:#fde68a;}
    .status.error{background:#fef2f2;color:#b91c1c;border-color:#fecaca;}

    .progress{height:6px;background:#f3f4f6;border-radius:999px;overflow:hidden;display:none;}
    .progress span{display:block;height:100%;width:0;background:var(--primary);transition:width .2s ease;}

    .convert{border:none;border-radius:15px;padding:16px;font-weight:700;background:var(--primary);color:#fff;display:flex;justify-content:center;align-items:center;gap:10px;letter-spacing:.1px;font-size:15px;cursor:pointer;transition:background .2s,transform .2s;box-shadow:0 18px 32px rgba(229,57,53,.32);}
    .convert:hover{background:var(--primary-dark);transform:translateY(-1px);}
    .convert:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none;}

    .options-toggle{display:none;position:fixed;right:16px;bottom:20px;z-index:40;background:var(--primary);color:#fff;border:none;padding:14px 18px;border-radius:999px;font-weight:600;box-shadow:0 14px 28px rgba(229,57,53,.35);}
    @media (max-width:1100px){
      .rightpanel{position:fixed;left:0;right:0;bottom:0;top:auto;border-radius:22px 22px 0 0;padding:22px 20px 96px;transform:translateY(110%);transition:transform .34s ease;z-index:39;max-height:85vh;overflow-y:auto;}
      .rightpanel.open{transform:translateY(0);}
      .options-toggle{display:inline-flex;gap:8px;align-items:center;}
    }

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body>
  <div class="app">
    <section class="board" id="board" aria-label="Danh sách tệp nguồn">
      <div class="dropzone" id="dropzone" tabindex="0">
        <div style="font-size:48px">📄 ➜ 🖼️</div>
        <strong>Kéo PDF hoặc ảnh vào đây</strong>
        <span>hoặc</span>
        <button type="button" id="chooseBtn">Chọn tệp</button>
        <div class="muted">Hỗ trợ PDF, PNG, JPG/JPEG, WebP, GIF, BMP — xuất JPG hoặc gộp PDF ngay trên trình duyệt</div>
        <input type="file" id="fileInput" accept="application/pdf,image/*" multiple hidden>
      </div>

      <div class="selection-bar" id="selectionBar" style="display:none;">
        <div><strong id="selectionCount">0 tệp</strong> <span id="pageCount">0 trang</span></div>
        <button class="clear-btn" id="clearAll" type="button">Xóa tất cả</button>
      </div>

      <div class="grid" id="fileGrid"></div>
      <div class="empty" id="emptyState">Chưa có tệp nào. Kéo PDF hoặc ảnh vào khung bên trên để bắt đầu.</div>
    </section>

    <aside class="rightpanel" id="panel">
      <h2>Xuất JPG hoặc PDF</h2>
      <p>Tải PDF hoặc ảnh, chọn xuất JPG hoặc gộp thành PDF rồi nhận gói ZIP chỉ sau vài bước.</p>

      <div>
        <p style="font-weight:600;margin-bottom:10px;color:#1f2937;">Chất lượng ảnh</p>
        <div class="quality" role="radiogroup">
          <div class="qitem active" tabindex="0" role="radio" data-quality="normal" aria-checked="true">
            <span class="badge">Khuyên dùng</span>
            <strong>Bình thường</strong>
            <small>150 DPI</small>
          </div>
          <div class="qitem" tabindex="0" role="radio" data-quality="high" aria-checked="false">
            <span class="badge">Cân bằng</span>
            <strong>Cao</strong>
            <small>220 DPI</small>
          </div>
          <div class="qitem" tabindex="0" role="radio" data-quality="ultra" aria-checked="false">
            <span class="badge">MAX DPI</span>
            <strong>Siêu nét</strong>
            <small>600 DPI</small>
          </div>
        </div>
      </div>

      <div class="output-format" role="group" aria-label="Định dạng đầu ra">
        <strong>Chọn định dạng xuất</strong>
        <div class="options">
          <button type="button" class="format-btn active" data-format="jpg" aria-pressed="true">Xuất ảnh JPG</button>
          <button type="button" class="format-btn" data-format="pdf" aria-pressed="false">Xuất thành PDF</button>
        </div>
      </div>

      <div class="pdf-options" id="pdfOptions" role="group" aria-label="Chế độ xuất PDF" aria-hidden="true">
        <strong>Chế độ xuất PDF</strong>
        <div class="options">
          <button type="button" class="pdf-mode-btn" data-mode="separate" aria-pressed="false" aria-disabled="true" disabled>Mỗi tệp 1 PDF</button>
          <button type="button" class="pdf-mode-btn active" data-mode="merged" aria-pressed="true" aria-disabled="true" disabled>Gộp thành 1 PDF</button>
        </div>
      </div>

      <div class="status" id="statusMessage" role="status" aria-live="polite"></div>

      <div class="progress" id="progressWrap" aria-hidden="true">
        <span id="progressBar"></span>
      </div>

      <button class="convert" id="convertBtn" type="button" disabled><span>Chuyển sang JPG</span></button>
    </aside>

    <button class="options-toggle" id="optsToggle" type="button">⚙️ Tùy chọn chuyển đổi</button>
  </div>

  <script src="./libs/pdfjs/pdf.min.js"></script>
  <script src="./libs/jszip/jszip.min.js"></script>
  <script src="./libs/filesaver/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const state = {
      files: [], // {id,type,file,name,pdf,pages,thumb,revokeThumb,imageInfo}
      quality: 'normal',
      pdfMode: 'merged',
      outputFormat: 'jpg',
      converting: false
    };

    const $ = (selector, scope=document) => scope.querySelector(selector);
    const $$ = (selector, scope=document) => Array.from(scope.querySelectorAll(selector));

    const dropzone = $('#dropzone');
    const fileInput = $('#fileInput');
    const grid = $('#fileGrid');
    const emptyState = $('#emptyState');
    const selectionBar = $('#selectionBar');
    const selectionCount = $('#selectionCount');
    const pageCount = $('#pageCount');
    const convertBtn = $('#convertBtn');
    const convertLabel = convertBtn.querySelector('span');
    const progressWrap = $('#progressWrap');
    const progressBar = $('#progressBar');
    const statusMessage = $('#statusMessage');
    const optsToggle = $('#optsToggle');
    const panel = $('#panel');
    const chooseBtn = $('#chooseBtn');
    const formatButtons = $$('.format-btn');
    const pdfOptions = $('#pdfOptions');
    const pdfModeButtons = $$('.pdf-mode-btn');
    const pdfjs = window.pdfjsLib || null;
    const SUPPORTED_IMAGE_MIME = ['image/png','image/jpeg','image/pjpeg','image/webp','image/gif','image/bmp','image/x-ms-bmp'];
    const IMAGE_EXTENSION_PATTERN = /\.(png|jpe?g|webp|gif|bmp)$/i;
    const isPdfFile = file => file && (file.type === 'application/pdf' || /\.pdf$/i.test(file.name || ''));
    const isImageFile = file => file && (SUPPORTED_IMAGE_MIME.includes(file.type) || IMAGE_EXTENSION_PATTERN.test(file.name || ''));
    const sanitizeName = name => (name || '').replace(/[\\/:*?"<>|]/g, '_').trim();
    const QUALITY_PRESETS = {
      normal: {
        label: 'bình thường',
        dpi: 150,
        jpegQuality: 0.82,
        message: 'Chế độ bình thường (150 DPI) giúp chuyển đổi nhanh và dung lượng nhẹ.',
        tone: 'info'
      },
      high: {
        label: 'cao',
        dpi: 220,
        jpegQuality: 0.92,
        message: 'Chế độ cao (220 DPI) cân bằng giữa độ nét và dung lượng tệp.',
        tone: 'info'
      },
      ultra: {
        label: 'siêu nét',
        dpi: 600,
        jpegQuality: 1,
        message: 'Chế độ siêu nét (600 DPI) tiêu tốn nhiều tài nguyên; hãy dùng với PDF ít trang và máy đủ mạnh.',
        tone: 'warn'
      }
    };
    const LONG_TASK_MESSAGES = {
      normal: {
        after15: 'Tệp lớn đang được xử lý. Vui lòng chờ, tiến trình có thể mất vài phút.',
        after45: 'Vẫn đang xử lý… Để rút ngắn thời gian với PDF lớn, hãy tách nhỏ tệp hoặc chỉ chọn những trang cần thiết.'
      },
      high: {
        after15: 'Đang xử lý với thiết lập chất lượng cao. Vui lòng đợi thêm một chút.',
        after45: 'Tiến trình vẫn tiếp tục… Nếu tệp quá lớn, hãy cân nhắc tách nhỏ hoặc chuyển một phần sang chế độ Bình thường.'
      },
      ultra: {
        after15: 'Đang xử lý ở chế độ Siêu Nét, vui lòng đợi thêm giây lát.',
        after45: 'Hệ thống vẫn chạy ở chế độ Siêu Nét. Với PDF rất lớn, tách nhỏ hoặc nén nhẹ sẽ giúp bạn nhận kết quả nhanh hơn.'
      }
    };

    const mql = window.matchMedia('(max-width:1100px)');
    const compactLabel = '⚙️ Tùy chọn chuyển đổi';
    const desktopLabel = 'Tùy chọn';

    const handleResponsive = () => {
      const isCompact = mql.matches;
      optsToggle.style.display = isCompact ? 'inline-flex' : 'none';
      optsToggle.textContent = isCompact ? compactLabel : desktopLabel;
      if(!isCompact){panel.classList.remove('open');}
    };
    handleResponsive();
    mql.addEventListener('change', handleResponsive);
    optsToggle.addEventListener('click', () => panel.classList.toggle('open'));

    document.addEventListener('click', event => {
      if(!panel.classList.contains('open') || !mql.matches) return;
      if(panel.contains(event.target)) return;
      if(optsToggle && optsToggle.contains(event.target)) return;
      panel.classList.remove('open');
    });

    function updateStatus(text='', tone='info'){
      if(!text){statusMessage.className = 'status'; statusMessage.textContent=''; return;}
      statusMessage.textContent = text;
      statusMessage.className = `status show ${tone}`;
    }

    function cleanupEntry(entry){
      if(!entry) return;
      if(entry.pdf){
        try{entry.pdf.destroy?.();}catch(_){}
      }
      entry.pdf = null;
      if(typeof entry.revokeThumb === 'function'){
        try{entry.revokeThumb();}catch(_){}
      }
      entry.revokeThumb = null;
      entry.thumb = null;
      entry.imageInfo = null;
    }

    function updateSelection(){
      const fileTotal = state.files.length;
      const itemTotal = state.files.reduce((sum,f)=>sum+(f.pages || (f.type === 'image' ? 1 : 0)),0);
      if(fileTotal){
        selectionBar.style.display = 'flex';
        selectionCount.textContent = `${fileTotal} tệp`;
        pageCount.textContent = `${itemTotal} ảnh/trang`;
      }else{
        selectionBar.style.display = 'none';
      }
      emptyState.style.display = fileTotal ? 'none':'block';
      convertBtn.disabled = !fileTotal || state.converting;
    }

    function renderGrid(){
      if(!state.files.length){
        grid.innerHTML = '';
        updateSelection();
        return;
      }
      const cards = state.files.map(f => {
        const info = f.type === 'image' ? '1 ảnh' : (f.pages ? `${f.pages} trang` : 'Đang xử lý');
        const alt = f.type === 'image' ? `Ảnh xem trước của ${f.name}` : `Trang đầu của ${f.name}`;
        const thumb = f.thumb ? `<img src="${f.thumb}" alt="${alt}">` : '<span class="muted">Đang tạo ảnh xem trước…</span>';
        return `
        <div class="card">
          <button class="remove" type="button" data-remove="${f.id}" title="Xóa tệp">×</button>
          <div class="thumb" data-pages="${info}">
            ${thumb}
          </div>
          <div class="filename" title="${f.name}">${f.name}</div>
        </div>`;
      }).join('');
      grid.innerHTML = cards;
      updateSelection();
    }

    async function fileToArrayBuffer(file){
      return await new Response(file).arrayBuffer();
    }

    async function loadPdfPreview(entry){
      if(!pdfjs) throw new Error('PDF.js chưa sẵn sàng');
      const buffer = await fileToArrayBuffer(entry.file);
      entry.pdf = await pdfjs.getDocument({data:buffer}).promise;
      entry.pages = entry.pdf.numPages;
      const page = await entry.pdf.getPage(1);
      const viewport = page.getViewport({scale:1.1});
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({canvasContext:ctx, viewport}).promise;
      entry.thumb = canvas.toDataURL('image/jpeg', .75);
    }

    async function renderPdfPageToCanvas(page, scale){
      const viewport = page.getViewport({scale});
      const canvas = document.createElement('canvas');
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      const ctx = canvas.getContext('2d', {alpha:false});
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      await page.render({canvasContext:ctx, viewport}).promise;
      return canvas;
    }

    async function loadImagePreview(entry){
      if(!entry || !entry.file) throw new Error('Thiếu dữ liệu tệp ảnh.');
      if(typeof entry.revokeThumb === 'function'){
        entry.revokeThumb();
      }
      const objectUrl = URL.createObjectURL(entry.file);
      await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          entry.pages = 1;
          entry.imageInfo = {width: img.naturalWidth || img.width, height: img.naturalHeight || img.height};
          entry.thumb = objectUrl;
          entry.revokeThumb = () => {
            URL.revokeObjectURL(objectUrl);
            entry.revokeThumb = null;
          };
          resolve();
        };
        img.onerror = err => {
          URL.revokeObjectURL(objectUrl);
          reject(err || new Error('Không thể đọc ảnh.'));
        };
        img.src = objectUrl;
      });
    }

    async function canvasToJpeg(canvas, quality){
      return await new Promise((resolve, reject) => {
        canvas.toBlob(result => result ? resolve(result) : reject(new Error('Không tạo được ảnh JPG.')), 'image/jpeg', quality);
      });
    }

    async function rasterizeImageFile(file){
      if('createImageBitmap' in window && typeof createImageBitmap === 'function'){
        let bitmap;
        try{
          bitmap = await createImageBitmap(file);
          const canvas = document.createElement('canvas');
          canvas.width = bitmap.width || 1;
          canvas.height = bitmap.height || 1;
          const ctx = canvas.getContext('2d', {alpha:false});
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(bitmap, 0, 0);
          bitmap.close?.();
          return canvas;
        }catch(err){
          bitmap?.close?.();
          throw err;
        }
      }
      const objectUrl = URL.createObjectURL(file);
      try{
        const img = await new Promise((resolve, reject) => {
          const image = new Image();
          image.onload = () => resolve(image);
          image.onerror = reject;
          image.src = objectUrl;
        });
        const width = img.naturalWidth || img.width || 1;
        const height = img.naturalHeight || img.height || 1;
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d', {alpha:false});
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,width,height);
        ctx.drawImage(img, 0, 0, width, height);
        return canvas;
      }finally{
        URL.revokeObjectURL(objectUrl);
      }
    }

    async function convertImageEntry(file, jpegQuality){
      if(!file) throw new Error('Thiếu dữ liệu ảnh nguồn.');
      const canvas = await rasterizeImageFile(file);
      return await canvasToJpeg(canvas, jpegQuality);
    }

    async function handleFiles(files){
      if(!files.length) return;
      updateStatus('Đang tải tệp…', 'info');
      let added = 0;
      const skippedPdf = [];
      const unsupported = [];

      for(const file of files){
        const pdfCandidate = isPdfFile(file);
        const imageCandidate = isImageFile(file);

        if(!pdfCandidate && !imageCandidate){
          unsupported.push(file.name);
          continue;
        }
        if(pdfCandidate && !pdfjs){
          skippedPdf.push(file.name);
          continue;
        }

        const id = Math.random().toString(36).slice(2,9);
        const entry = {
          id,
          type: pdfCandidate ? 'pdf' : 'image',
          file,
          name:file.name,
          pdf:null,
          pages: pdfCandidate ? 0 : 1,
          thumb:null,
          revokeThumb:null,
          imageInfo:null
        };
        state.files.push(entry);
        renderGrid();
        try{
          if(pdfCandidate){
            await loadPdfPreview(entry);
          }else{
            await loadImagePreview(entry);
          }
          added++;
          renderGrid();
        }catch(err){
          console.error('Không thể đọc tệp', err);
          cleanupEntry(entry);
          state.files = state.files.filter(f => f.id !== id);
          renderGrid();
          updateStatus(`Không thể đọc tệp ${file.name}.`, 'error');
        }
      }

      if(added){
        const notes = [];
        if(skippedPdf.length){
          notes.push(`Không xử lý được ${skippedPdf.length} tệp PDF vì thư viện PDF.js chưa sẵn sàng.`);
        }
        if(unsupported.length){
          notes.push(`Bỏ qua ${unsupported.length} tệp không được hỗ trợ.`);
        }
        const actionLabel = convertLabel ? convertLabel.textContent : 'Chuyển sang JPG';
        const message = [`Tệp đã sẵn sàng, bấm "${actionLabel}".`, ...notes].join(' ');
        updateStatus(message, notes.length ? 'warn' : 'success');
      }else if(skippedPdf.length){
        updateStatus('Không thể xử lý PDF vì thư viện PDF.js chưa tải xong. Hãy kiểm tra kết nối Internet và tải lại trang.', 'error');
      }else if(unsupported.length){
        updateStatus('Các tệp bạn chọn không thuộc định dạng được hỗ trợ (PDF, PNG, JPG, WebP, GIF, BMP).', 'warn');
      }else{
        updateStatus('Không có tệp mới nào được thêm.', 'info');
      }
    }

    dropzone.addEventListener('click', e => {
      if (e.target.closest('button')) return;
      fileInput.click();
    });
    chooseBtn.addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();
      fileInput.click();
    });
    fileInput.addEventListener('change', () => {
      handleFiles(Array.from(fileInput.files || []));
      fileInput.value = '';
    });

    ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, e => {
      e.preventDefault();
      if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
      dropzone.classList.add('dragover');
    }));
    dropzone.addEventListener('dragleave', e => {
      if (e.target === dropzone) {
        dropzone.classList.remove('dragover');
      }
    });
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files || []).filter(f => isPdfFile(f) || isImageFile(f));
      if(files.length){handleFiles(files);} else {updateStatus('Vui lòng thả PDF hoặc ảnh tĩnh.', 'warn');}
    });

    window.addEventListener('dragover', e => e.preventDefault());
    window.addEventListener('drop', e => e.preventDefault());

    $('#clearAll').addEventListener('click', () => {
      state.files.forEach(cleanupEntry);
      state.files = [];
      renderGrid();
      updateStatus('Đã xóa danh sách tệp.', 'info');
    });

    grid.addEventListener('click', e => {
      const btn = e.target.closest('[data-remove]');
      if(!btn) return;
      const id = btn.getAttribute('data-remove');
      const entry = state.files.find(f => f.id === id);
      if(entry){
        cleanupEntry(entry);
      }
      state.files = state.files.filter(f => f.id !== id);
      renderGrid();
      updateStatus('Đã loại bỏ tệp khỏi danh sách.', 'info');
    });

    $$('.qitem').forEach(item => {
      item.addEventListener('click', () => setQuality(item.dataset.quality));
      item.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' '){e.preventDefault(); setQuality(item.dataset.quality);} 
      });
    });

    if(formatButtons.length){
      formatButtons.forEach(btn => {
        btn.addEventListener('click', () => setOutputFormat(btn.dataset.format));
      });
    }
    if(pdfModeButtons.length){
      pdfModeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          if(btn.disabled) return;
          setPdfMode(btn.dataset.mode);
        });
      });
    }
    function updatePdfOptionsVisibility(){
      if(!pdfOptions) return;
      const show = state.outputFormat === 'pdf';
      pdfOptions.style.display = show ? 'block' : 'none';
      pdfOptions.setAttribute('aria-hidden', show ? 'false' : 'true');
      pdfModeButtons.forEach(btn => {
        btn.disabled = !show;
        btn.setAttribute('aria-disabled', show ? 'false' : 'true');
      });
      if(show){
        setPdfMode(state.pdfMode);
      }
    }

    function setPdfMode(mode){
      const next = mode === 'merged' ? 'merged' : 'separate';
      state.pdfMode = next;
      pdfModeButtons.forEach(btn => {
        const active = btn.dataset.mode === next;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    function setQuality(quality){
      const key = QUALITY_PRESETS[quality] ? quality : 'normal';
      state.quality = key;
      $$('.qitem').forEach(el => {
        const active = el.dataset.quality === key;
        el.classList.toggle('active', active);
        el.setAttribute('aria-checked', active);
      });
      const preset = QUALITY_PRESETS[key];
      updateStatus(preset.message, preset.tone);
    }

    function updateConvertLabel(){
      if(!convertLabel) return;
      convertLabel.textContent = state.outputFormat === 'pdf' ? 'Xuất sang PDF' : 'Chuyển sang JPG';
    }

    function setOutputFormat(format){
      const next = format === 'pdf' ? 'pdf' : 'jpg';
      state.outputFormat = next;
      formatButtons.forEach(btn => {
        const active = btn.dataset.format === next;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
      updateConvertLabel();
      updatePdfOptionsVisibility();
    }

    async function loadPdf(entry){
      if(!pdfjs) throw new Error('PDF.js chưa sẵn sàng');
      if(entry.pdf) return entry.pdf;
      const buffer = await fileToArrayBuffer(entry.file);
      entry.pdf = await pdfjs.getDocument({data:buffer}).promise;
      entry.pages = entry.pdf.numPages;
      return entry.pdf;
    }

    function createLongTaskTimers(quality='normal', tone='info'){
      const key = LONG_TASK_MESSAGES[quality] ? quality : 'normal';
      const messages = LONG_TASK_MESSAGES[key];
      const timers = [];
      timers.push(setTimeout(() => updateStatus(messages.after15, tone), 15000));
      timers.push(setTimeout(() => updateStatus(messages.after45, tone), 45000));
      return () => timers.forEach(clearTimeout);
    }

    async function convert(){
      if(!state.files.length || state.converting) return;
      const exportingPdf = state.outputFormat === 'pdf';
      const mergeAll = exportingPdf && state.pdfMode === 'merged';
      const hasPdf = state.files.some(f => f.type === 'pdf');
      if(hasPdf && !pdfjs){
        updateStatus('Không thể xử lý PDF vì thư viện PDF.js chưa tải xong. Bạn vẫn có thể chuyển ảnh trực tiếp hoặc tải lại trang.', 'error');
        return;
      }
      const jsPDFLib = exportingPdf ? (window.jspdf && window.jspdf.jsPDF) : null;
      if(exportingPdf && !jsPDFLib){
        updateStatus('Không tải được thư viện tạo PDF. Hãy kiểm tra kết nối Internet rồi thử lại.', 'error');
        return;
      }
      state.converting = true;
      convertBtn.disabled = true;
      const preset = QUALITY_PRESETS[state.quality] || QUALITY_PRESETS.normal;
      const tone = preset.tone === 'warn' ? 'warn' : 'info';
      const scale = preset.dpi / 72;
      const jpegQuality = preset.jpegQuality;
      const startMessage = exportingPdf
        ? (mergeAll
          ? (tone === 'warn' ? 'Bắt đầu gộp sang một file PDF ở chế độ siêu nét. Tiến trình có thể lâu hơn bình thường…' : 'Bắt đầu gộp các trang/ảnh sang một file PDF…')
          : (tone === 'warn' ? 'Bắt đầu xuất sang PDF ở chế độ siêu nét. Tiến trình có thể lâu hơn bình thường…' : 'Bắt đầu xuất sang PDF…'))
        : (tone === 'warn' ? 'Bắt đầu chuyển đổi ở chế độ siêu nét. Tiến trình có thể lâu hơn bình thường…' : 'Bắt đầu chuyển đổi…');
      updateStatus(startMessage, tone);
      progressWrap.style.display = 'block';
      progressBar.style.width = '0%';

      const releaseTimers = createLongTaskTimers(state.quality, tone);
      const zip = new JSZip();
      let totalItems = state.files.reduce((sum, entry) => {
        if(entry.type === 'pdf'){
          return sum + (entry.pages || entry.pdf?.numPages || 1);
        }
        return sum + 1;
      }, 0);
      if(!totalItems) totalItems = state.files.length || 1;
      let processed = 0;
      let mergedDoc = null;
      const incrementProgress = () => {
        processed++;
        progressBar.style.width = Math.round(processed / totalItems * 100) + '%';
      };
      const appendCanvasToDoc = (doc, canvas) => {
        const orientation = canvas.width >= canvas.height ? 'l' : 'p';
        const format = [canvas.width || 1, canvas.height || 1];
        const dataUrl = canvas.toDataURL('image/jpeg', jpegQuality);
        if(!doc){
          doc = new jsPDFLib({orientation, unit:'px', format});
        }else{
          doc.addPage(format, orientation);
        }
        doc.addImage(dataUrl, 'JPEG', 0, 0, canvas.width, canvas.height);
        return doc;
      };

      try{
        for(const entry of state.files){
          const baseLabel = entry.name ? entry.name.replace(/\.[^.]+$/, '') : '';
          const folderBase = sanitizeName(baseLabel) || `tep-${entry.id}`;
          const folder = (!exportingPdf || !mergeAll) ? zip.folder(folderBase) : null;
          const collectImagePdf = exportingPdf && !mergeAll && entry.type === 'image';
          let entryDoc = null;

          if(entry.type === 'pdf'){
            const pdf = await loadPdf(entry);
            const pageCount = pdf.numPages || 1;
            const actionVerb = exportingPdf ? (mergeAll ? 'gộp' : 'xuất') : 'chuyển đổi';
            const targetLabel = exportingPdf ? 'PDF' : 'JPG';
            updateStatus(`Đang ${actionVerb} "${entry.name}" sang ${targetLabel}…`, tone);

            for(let i=1; i<=pageCount; i++){
              const page = await pdf.getPage(i);
              const canvas = await renderPdfPageToCanvas(page, scale);

              if(exportingPdf && jsPDFLib){
                if(mergeAll){
                  mergedDoc = appendCanvasToDoc(mergedDoc, canvas);
                }else{
                  const singleDoc = appendCanvasToDoc(null, canvas);
                  const pdfBlob = singleDoc.output('blob');
                  const target = folder || zip;
                  const pdfName = pageCount > 1
                    ? `page-${String(i).padStart(3,'0')}.pdf`
                    : `${folderBase}.pdf`;
                  target.file(pdfName, pdfBlob);
                }
              }else{
                const blob = await canvasToJpeg(canvas, jpegQuality);
                const buffer = await blob.arrayBuffer();
                folder?.file(`page-${String(i).padStart(3,'0')}.jpg`, buffer);
              }

              incrementProgress();
            }
          }else if(entry.type === 'image'){
            const actionVerb = exportingPdf ? (mergeAll ? 'gộp ảnh' : 'xuất ảnh') : 'chuyển đổi ảnh';
            const targetLabel = exportingPdf ? 'PDF' : 'JPG';
            updateStatus(`Đang ${actionVerb} "${entry.name}" sang ${targetLabel}…`, tone);

            const canvas = await rasterizeImageFile(entry.file);
            if(exportingPdf && jsPDFLib){
              if(mergeAll){
                mergedDoc = appendCanvasToDoc(mergedDoc, canvas);
              }else{
                entryDoc = appendCanvasToDoc(entryDoc, canvas);
              }
            }else{
              const blob = await convertImageEntry(entry.file, jpegQuality);
              const buffer = await blob.arrayBuffer();
              folder?.file('image-001.jpg', buffer);
            }

            incrementProgress();
          }

          if(collectImagePdf && entryDoc){
            const pdfBlob = entryDoc.output('blob');
            if(folder){
              folder.file(`${folderBase}.pdf`, pdfBlob);
            }else{
              zip.file(`${folderBase}.pdf`, pdfBlob);
            }
          }
        }

        if(mergeAll && mergedDoc){
          const mergedBlob = mergedDoc.output('blob');
          const mergedName = state.files.length === 1
            ? `${sanitizeName(state.files[0].name.replace(/\.[^.]+$/, '')) || 'tap-tin'}.pdf`
            : `tong-hop-${state.files.length}-tep.pdf`;
          zip.file(mergedName, mergedBlob);
        }

        const zipBlob = await zip.generateAsync({type:'blob'});
        const zipNameBase = exportingPdf ? (mergeAll ? 'tap-tin-gop-pdf' : 'tap-tin-sang-pdf') : 'tap-tin-sang-jpg';
        saveAs(zipBlob, `${zipNameBase}-${Date.now()}.zip`);
        updateStatus('Hoàn tất! Đang tải xuống tệp ZIP.', 'success');
      }catch(err){
        console.error(err);
        updateStatus('Đã xảy ra lỗi trong quá trình chuyển đổi. Vui lòng thử lại.', 'error');
      }finally{
        releaseTimers();
        progressWrap.style.display = 'none';
        progressBar.style.width = '0%';
        state.converting = false;
        convertBtn.disabled = !state.files.length;
      }
    }

    if (pdfjs) {
      pdfjs.GlobalWorkerOptions.workerSrc = './libs/pdfjs/pdf.worker.min.js';
    } else {
      updateStatus('Không tải được thư viện xử lý PDF. Bạn vẫn có thể chuyển ảnh sang JPG; PDF sẽ bị bỏ qua cho tới khi thư viện sẵn sàng.', 'warn');
    }

    convertBtn.addEventListener('click', convert);

    window.addEventListener('keydown', e => {
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'o'){
        e.preventDefault();
        fileInput.click();
      }
    });

    setPdfMode(state.pdfMode);
    setOutputFormat(state.outputFormat);
    renderGrid();
  </script>
</body>
</html>
