<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF sang Word - Giữ nguyên bố cục</title>
  <meta name="description" content="Chuyển PDF sang Word trực tuyến bằng cách nhúng từng trang vào DOCX, giữ đúng bố cục, font chữ và watermark." />
  <meta name="robots" content="index,follow" />
  <meta property="og:title" content="PDF sang Word — Giữ nguyên bố cục tài liệu" />
  <meta property="og:description" content="Chuyển PDF sang Word trực tuyến, giữ nguyên định dạng, font chữ và watermark cho từng trang DOCX." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://pdf-converter.tools/pdf-sang-word" />
  <meta property="og:locale" content="vi_VN" />
  <meta property="og:site_name" content="PDF Converter Tools" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="PDF sang Word — Giữ nguyên bố cục" />
  <meta name="twitter:description" content="Công cụ PDF sang Word giữ nguyên bố cục, hỗ trợ kéo thả và tải xuống DOCX nhanh chóng." />
  <link rel="canonical" href="https://pdf-converter.tools/pdf-sang-word" />
  <link rel="alternate" href="https://pdf-converter.tools/pdf-sang-word" hreflang="vi" />
  <link rel="alternate" href="https://pdf-converter.tools/pdf-sang-word" hreflang="x-default" />
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "PDF sang Word",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "Any",
    "description": "Chuyển PDF sang Word trực tuyến, giữ nguyên bố cục tài liệu bằng cách nhúng ảnh trang vào DOCX.",
    "url": "https://pdf-converter.tools/pdf-sang-word",
    "offers": {
      "@type": "Offer",
      "price": "0.00",
      "priceCurrency": "USD"
    }
  }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#eef3ff;
      --surface:#ffffff;
      --muted:#5f6b7d;
      --text:#0f172a;
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --ring:rgba(37,99,235,.18);
      --shadow:0 22px 44px rgba(15,23,42,.1),0 12px 24px rgba(15,23,42,.06);
      --radius:20px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    body.aside-open{overflow:hidden;}

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns:minmax(0,1fr) 340px;
      gap:28px;
      padding:28px;
    }
    @media(max-width:1100px){
      .app{
        grid-template-columns:1fr;
        gap:18px;
        padding:16px;
      }
      .options-toggle{display:inline-flex;}
    }
    @media(max-width:640px){
      .app{padding:14px 14px 96px;}
    }

    .board{
      background:linear-gradient(180deg,#f7f9ff 0%,#e5edff 100%);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:32px 30px;
      display:flex;
      flex-direction:column;
      gap:22px;
    }
    @media(max-width:640px){
      .board{padding:22px 18px;}
    }
    @media(max-width:375px){
      .app{padding:60px 12px 96px;}
      .options-toggle{top:16px;bottom:auto;right:12px;}
      .board{padding:20px 16px;}
      .board header h1{font-size:24px;}
      .board header p{font-size:14px;}
      .dropzone{padding:40px 18px;}
      .dropzone strong{font-size:18px;}
      .dropzone button{padding:12px 18px;font-size:14px;}
      .selection{padding:14px 16px;}
      .grid{grid-template-columns:1fr;}
      .downloads{padding:16px;}
      .aside{padding:22px 18px;}
      .aside h2{font-size:20px;}
    }

    .board header h1{
      margin:0;
      font-size:30px;
      font-weight:700;
      color:#102347;
    }
    .board header p{
      margin:10px 0 0;
      font-size:15px;
      line-height:1.6;
      color:var(--muted);
      max-width:680px;
    }

    .dropzone{
      border:2px dashed rgba(37,99,235,.45);
      border-radius:24px;
      background:rgba(255,255,255,.92);
      padding:58px 30px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      justify-content:center;
      transition:all .2s ease;
      cursor:pointer;
    }
    .dropzone:hover,
    .dropzone:focus-visible,
    .dropzone.dragover{
      border-color:var(--primary);
      box-shadow:0 0 0 10px var(--ring);
      transform:translateY(-2px);
    }
    .dropzone strong{font-size:20px;font-weight:700;color:#152647;}
    .dropzone button{
      border:none;
      background:var(--primary);
      color:#fff;
      font-weight:600;
      border-radius:14px;
      padding:14px 22px;
      cursor:pointer;
      box-shadow:0 20px 34px rgba(37,99,235,.25);
      transition:background .18s ease,transform .18s ease;
    }
    .dropzone button:hover{background:var(--primary-dark);transform:translateY(-1px);}
    .dropzone .muted{color:var(--muted);font-size:13px;}

    .selection{
      display:none;
      border-radius:16px;
      background:rgba(255,255,255,.95);
      padding:16px 18px;
      box-shadow:0 16px 30px rgba(15,23,42,.08);
      font-weight:600;
      justify-content:space-between;
      align-items:center;
    }
    .selection span{color:var(--muted);font-weight:500;margin-left:12px;}
    .selection button{
      border:none;
      background:transparent;
      color:var(--primary);
      font-weight:600;
      cursor:pointer;
    }
    .selection button:disabled{opacity:.45;cursor:not-allowed;}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:18px;
    }
    .card{
      position:relative;
      background:var(--surface);
      border-radius:16px;
      box-shadow:0 16px 36px rgba(15,23,42,.12);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      transition:transform .2s ease,box-shadow .2s ease;
    }
    .card:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(15,23,42,.16);}
    .card .thumb{
      width:100%;
      aspect-ratio:3/4;
      border-radius:14px;
      background:#e0e8ff;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .card .thumb::after{
      content:attr(data-pages);
      position:absolute;
      bottom:10px;
      right:10px;
      background:rgba(15,23,42,.85);
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    .card .thumb span{font-weight:700;color:var(--primary);font-size:18px;letter-spacing:.5px;}
    .card .filename{font-size:13px;font-weight:600;text-align:center;color:#1b2545;word-break:break-word;}
    .card .meta{font-size:12px;text-align:center;color:var(--muted);}
    .card .remove{
      position:absolute;
      top:10px;
      right:10px;
      border:none;
      background:#fff;
      width:26px;
      height:26px;
      border-radius:50%;
      color:#ef4444;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(239,68,68,.28);
    }

    .empty{
      border:1px dashed #c5d3f7;
      border-radius:18px;
      padding:36px 20px;
      text-align:center;
      color:#8b9bbd;
      font-size:14px;
    }

    .downloads{
      display:none;
      background:rgba(255,255,255,.94);
      border-radius:16px;
      padding:18px;
      box-shadow:0 18px 34px rgba(15,23,42,.12);
      gap:12px;
      flex-direction:column;
    }
    .downloads a{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-radius:12px;
      text-decoration:none;
      background:#f3f6ff;
      color:#1f2d4a;
      transition:background .2s ease,transform .2s ease;
    }
    .downloads a:hover{background:#e0e8ff;transform:translateY(-1px);}
    .downloads a span{display:block;font-size:12px;color:var(--muted);}

    .aside{
      background:var(--surface);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:28px;
      display:flex;
      flex-direction:column;
      gap:22px;
      position:sticky;
      top:28px;
      height:max-content;
    }
    .aside-intro{display:flex;flex-direction:column;gap:8px;}
    @media(max-width:1100px){
      .aside{
        display:none !important;
        position:static;
        box-shadow:none;
        padding:0;
      }
      .aside.open{
        display:flex !important;
        position:fixed;
        left:0;
        right:0;
        bottom:0;
        top:auto;
        border-radius:22px 22px 0 0;
        padding:24px 20px 96px;
        box-shadow:0 -12px 36px rgba(15,23,42,.18);
        max-height:85vh;
        overflow-y:auto;
      }
    }
    @media(max-width:1100px){
      .aside-intro{display:none !important;}
      .aside:not(.open) .convert-btn,
      .aside:not(.open) .status-box,
      .aside:not(.open) .note{display:none;}
    }
    .aside h2{margin:0;font-size:24px;font-weight:700;}
    .aside p{margin:0;color:var(--muted);line-height:1.6;font-size:14px;}

    .status-box{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:16px 18px;
      border-radius:16px;
      background:#edf2ff;
      color:var(--primary-dark);
      font-size:14px;
      line-height:1.55;
    }
    .status-box[data-status="success"]{background:#ecfdf3;color:#15803d;}
    .status-box[data-status="warn"]{background:#fff7ed;color:#b45309;}
    .status-box[data-status="error"]{background:#fee2e2;color:#b91c1c;}
    .status-box .icon{font-weight:700;font-size:18px;}

    .progress{
      display:none;
      flex-direction:column;
      gap:8px;
    }
    .progress label{font-size:13px;color:var(--muted);font-weight:500;}
    .progress-bar{width:100%;height:10px;background:#dbe4ff;border-radius:999px;overflow:hidden;}
    .progress-bar span{display:block;width:0;height:100%;background:var(--primary);border-radius:999px;transition:width .18s ease;}

    .convert-btn{
      border:none;
      background:linear-gradient(135deg,#2563eb,#3b82f6);
      color:#fff;
      font-weight:700;
      font-size:16px;
      border-radius:14px;
      padding:16px;
      cursor:pointer;
      box-shadow:0 24px 40px rgba(37,99,235,.28);
      transition:transform .18s ease,box-shadow .18s ease,filter .18s ease;
    }
    .convert-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 30px 46px rgba(37,99,235,.32);filter:brightness(1.05);}
    .convert-btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;}

    .note{font-size:12px;color:#94a3b8;line-height:1.6;}

    .options-toggle{
      display:none;
      position:fixed;
      right:16px;
      bottom:20px;
      z-index:40;
      background:var(--primary);
      color:#fff;
      border:none;
      padding:14px 18px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 16px 32px rgba(37,99,235,.32);
      gap:8px;
      align-items:center;
    }
  </style>
</head>
<body>
  <button class="options-toggle" id="optionsToggle" type="button" aria-expanded="false">⚙️ Tùy chọn chuyển đổi</button>
  <div class="app">
    <section class="board">
      <header>
        <h1>Chuyển PDF sang Word</h1>
        <p>Kéo thả PDF để chuyển thành DOCX giữ nguyên bố cục. Công cụ xử lý trực tiếp trên máy của bạn nên không giới hạn dung lượng tệp.</p>
      </header>

      <div class="dropzone" id="dropzone" tabindex="0" role="button" aria-label="Thêm tệp PDF để chuyển sang Word">
        <strong>Thả PDF vào đây</strong>
        <span>hoặc</span>
        <button type="button" id="chooseBtn">Chọn tệp PDF</button>
        <div class="muted">Hỗ trợ kéo thả nhiều tệp cùng lúc trên mọi trình duyệt hiện đại.</div>
        <input type="file" id="fileInput" accept="application/pdf" multiple hidden />
      </div>

      <div class="selection" id="selectionBar">
        <div>
          <strong id="selectionTitle">0 tệp</strong>
          <span id="selectionSize">0 B</span>
        </div>
        <button type="button" id="clearAll" disabled>Xóa tất cả</button>
      </div>

      <div class="grid" id="fileGrid"></div>
      <div class="empty" id="emptyState">Chưa có tệp. Kéo PDF vào khung hoặc nhấn “Chọn tệp PDF”.</div>

      <div class="downloads" id="downloadList"></div>
    </section>

    <aside class="aside">
      <div class="aside-intro">
        <h2>Tạo DOCX giống hệt PDF</h2>
        <p>Mỗi trang PDF được kết xuất thành ảnh độ phân giải cao và nhúng vào Word. Logo, watermark và định dạng vẫn y nguyên.</p>
      </div>

      <div class="status-box" id="statusBox" data-status="info">
        <span class="icon" id="statusIcon">ℹ️</span>
        <div id="statusText">Thêm ít nhất một tệp PDF để bắt đầu chuyển đổi.</div>
      </div>

      <div class="progress" id="progressWrap">
        <label id="progressLabel">Đang chuẩn bị...</label>
        <div class="progress-bar"><span id="progressBar"></span></div>
      </div>

      <button class="convert-btn" id="convertBtn" type="button" disabled>Chuyển sang Word</button>

      <div class="note">
        Việc chuyển đổi diễn ra cục bộ. Nếu tệp rất lớn, trình duyệt có thể cần thêm thời gian để dựng ảnh từng trang.
      </div>
    </aside>
  </div>

  <script src="./libs/pdfjs/pdf.min.js"></script>
  <script src="./libs/jszip/jszip.min.js"></script>
  <script src="./libs/filesaver/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <script>
    (function(){
      const pdfjs = window.pdfjsLib || window["pdfjs-dist/build/pdf"];
      if(pdfjs && pdfjs.GlobalWorkerOptions){
        pdfjs.GlobalWorkerOptions.workerSrc = "./libs/pdfjs/pdf.worker.min.js";
      }
      const JSZipLib = window.JSZip;
      const saveFile = window.saveAs;
      const docx = window.docx;

      const state = {
        files: [],
        converting: false
      };
      let downloads = [];

      const $ = (sel, scope=document) => scope.querySelector(sel);
      const $$ = (sel, scope=document) => Array.from(scope.querySelectorAll(sel));

      const dropzone = $("#dropzone");
      const chooseBtn = $("#chooseBtn");
      const fileInput = $("#fileInput");
      const selectionBar = $("#selectionBar");
      const selectionTitle = $("#selectionTitle");
      const selectionSize = $("#selectionSize");
      const clearAll = $("#clearAll");
      const fileGrid = $("#fileGrid");
      const emptyState = $("#emptyState");
      const downloadList = $("#downloadList");
      const optionsToggle = $("#optionsToggle");
      const aside = $(".aside");
      const convertBtn = $("#convertBtn");
      const statusBox = $("#statusBox");
      const statusIcon = $("#statusIcon");
      const statusText = $("#statusText");
      const progressWrap = $("#progressWrap");
      const progressLabel = $("#progressLabel");
      const progressBar = $("#progressBar");

      const closeOptionsPanel = () => {
        if(!aside || !optionsToggle) return;
        aside.classList.remove("open");
        optionsToggle.setAttribute("aria-expanded", "false");
        document.body.classList.remove("aside-open");
      };

      const toggleOptionsPanel = () => {
        if(!aside || !optionsToggle) return;
        const isOpen = aside.classList.toggle("open");
        optionsToggle.setAttribute("aria-expanded", String(isOpen));
        document.body.classList.toggle("aside-open", isOpen);
      };

      const breakpoint = window.matchMedia("(max-width:1100px)");
      const syncResponsiveState = () => {
        if(!optionsToggle) return;
        optionsToggle.style.display = breakpoint.matches ? "inline-flex" : "none";
        if(!breakpoint.matches){
          closeOptionsPanel();
        }
      };
      syncResponsiveState();
      breakpoint.addEventListener("change", syncResponsiveState);
      if(optionsToggle){
        optionsToggle.addEventListener("click", toggleOptionsPanel);
      }

      const formatBytes = bytes => {
        if(!bytes) return "0 B";
        const units = ["B","KB","MB","GB","TB"];
        const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
        return `${(bytes / Math.pow(1024, exponent)).toFixed(exponent ? 1 : 0)} ${units[exponent]}`;
      };

      const setStatus = (message, type="info") => {
        statusBox.dataset.status = type;
        const icons = { info:"ℹ️", success:"✅", warn:"⚠️", error:"⛔" };
        statusIcon.textContent = icons[type] || "ℹ️";
        statusText.textContent = message;
      };

      const updateSelection = () => {
        const count = state.files.length;
        if(count){
          selectionBar.style.display = "flex";
          clearAll.disabled = false;
          selectionTitle.textContent = `${count} ${count > 1 ? "tệp" : "tệp"}`;
          const totalSize = state.files.reduce((sum,item)=>sum + (item.file?.size || 0),0);
          selectionSize.textContent = formatBytes(totalSize);
        }else{
          selectionBar.style.display = "none";
          clearAll.disabled = true;
        }
        convertBtn.disabled = !count || state.converting;
      };

      const renderFiles = () => {
        if(!state.files.length){
          fileGrid.innerHTML = "";
          emptyState.style.display = "block";
        }else{
          emptyState.style.display = "none";
          fileGrid.innerHTML = state.files.map((entry,index) => `
            <div class="card" data-index="${index}">
              <button class="remove" type="button" data-remove="${index}" aria-label="Xóa ${entry.name}">×</button>
              <div class="thumb" data-pages="${entry.pages ? entry.pages + " trang" : "Đang đọc"}">
                <span>PDF</span>
              </div>
              <div class="filename" title="${entry.name}">${entry.name}</div>
              <div class="meta">${formatBytes(entry.file.size)}</div>
            </div>
          `).join("");
        }
        updateSelection();
      };

      const renderDownloads = () => {
        if(!downloads.length){
          downloadList.style.display = "none";
          downloadList.innerHTML = "";
          return;
        }
        downloadList.style.display = "flex";
        downloadList.innerHTML = downloads.map((item,index) => `
          <a href="#" data-download="${index}">
            <div>
              <strong>${item.name}</strong>
              ${item.note ? `<span>${item.note}</span>` : ""}
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 5v14m0 0-5-5m5 5 5-5"></path><path d="M5 19h14"></path></svg>
          </a>
        `).join("");
      };

      const ensurePdf = async entry => {
        if(entry.pdf){
          return entry.pdf;
        }
        const buffer = await entry.file.arrayBuffer();
        const pdf = await pdfjs.getDocument({ data: buffer }).promise;
        entry.pdf = pdf;
        entry.pages = pdf.numPages;
        return pdf;
      };

      const releasePdf = entry => {
        if(entry.pdf?.destroy){
          entry.pdf.destroy();
        }
        entry.pdf = null;
      };

      const addFiles = async files => {
        const pdfFiles = Array.from(files).filter(file => file.type === "application/pdf" || /\.pdf$/i.test(file.name));
        if(!pdfFiles.length){
          setStatus("Vui lòng chọn đúng định dạng PDF.", "warn");
          return;
        }
        let added = 0;
        for(const file of pdfFiles){
          const exists = state.files.some(item => item.name === file.name && item.file.size === file.size);
          if(exists){
            setStatus(`Tệp ${file.name} đã có trong danh sách.`, "warn");
            continue;
          }
          const entry = {
            id: Math.random().toString(36).slice(2,10),
            file,
            name: file.name,
            pages: null,
            pdf: null
          };
          state.files.push(entry);
          added++;
          renderFiles();
          try{
            await ensurePdf(entry);
            renderFiles();
          }catch(error){
            console.error(error);
            setStatus(`Không thể đọc tệp ${file.name}.`, "error");
            state.files = state.files.filter(item => item.id !== entry.id);
            renderFiles();
          }
        }
        if(added){
          setStatus("Tệp đã sẵn sàng. Nhấn “Chuyển sang Word”.", "success");
        }
      };

      dropzone.addEventListener("click", evt => {
        if(evt.target.closest("button")) return;
        fileInput.click();
      });
      chooseBtn.addEventListener("click", evt => {
        evt.preventDefault();
        evt.stopPropagation();
        fileInput.click();
      });
      dropzone.addEventListener("keydown", evt => {
        if(evt.key === "Enter" || evt.key === " "){
          evt.preventDefault();
          fileInput.click();
        }
      });
      fileInput.addEventListener("change", evt => {
        addFiles(evt.target.files);
        fileInput.value = "";
      });
      ["dragenter","dragover"].forEach(type => {
        dropzone.addEventListener(type, evt => {
          evt.preventDefault();
          if(evt.dataTransfer) evt.dataTransfer.dropEffect = "copy";
          dropzone.classList.add("dragover");
        });
      });
      ["dragleave","drop"].forEach(type => {
        dropzone.addEventListener(type, evt => {
          if(type === "dragleave" && evt.target !== dropzone) return;
          evt.preventDefault();
          dropzone.classList.remove("dragover");
        });
      });
      dropzone.addEventListener("drop", evt => {
        evt.preventDefault();
        addFiles(evt.dataTransfer?.files || []);
      });

      fileGrid.addEventListener("click", evt => {
        const btn = evt.target.closest("[data-remove]");
        if(!btn) return;
        const index = Number(btn.dataset.remove);
        if(Number.isInteger(index)){
          const [removed] = state.files.splice(index,1);
          if(removed) releasePdf(removed);
          renderFiles();
          if(!state.files.length){
            downloads = [];
            renderDownloads();
            setStatus("Danh sách trống. Thêm tệp mới để tiếp tục.", "info");
          }
        }
      });

      clearAll.addEventListener("click", () => {
        state.files.forEach(releasePdf);
        state.files = [];
        renderFiles();
        downloads = [];
        renderDownloads();
        setStatus("Đã xóa toàn bộ tệp.", "info");
      });

      downloadList.addEventListener("click", evt => {
        const link = evt.target.closest("[data-download]");
        if(!link) return;
        evt.preventDefault();
        const index = Number(link.dataset.download);
        const entry = downloads[index];
        if(entry && typeof saveFile === "function"){
          saveFile(entry.blob, entry.name);
          setStatus(`Đang tải lại ${entry.name}.`, "info");
        }
      });

      const buildDocxFromImages = async entry => {
        const pdf = await ensurePdf(entry);
        const pages = pdf.numPages || 1;
        const sections = [];
        for(let pageIndex=1; pageIndex<=pages; pageIndex++){
          progressLabel.textContent = `Đang kết xuất trang ${pageIndex}/${pages} của “${entry.name}”`;
          const page = await pdf.getPage(pageIndex);
          const baseViewport = page.getViewport({ scale:1 });
          const scale = 2.4;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement("canvas");
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);
          const context = canvas.getContext("2d", { alpha:false });
          context.fillStyle = "#ffffff";
          context.fillRect(0,0,canvas.width,canvas.height);
          await page.render({ canvasContext:context, viewport }).promise;
          const blob = await new Promise((resolve,reject)=>{
            canvas.toBlob(result => result ? resolve(result) : reject(new Error("Không tạo được ảnh trang")), "image/png", 0.96);
          });
          const buffer = await blob.arrayBuffer();
          const widthInches = baseViewport.width / 72;
          const heightInches = baseViewport.height / 72;
          sections.push({
            data: new Uint8Array(buffer),
            width: widthInches,
            height: heightInches
          });
        }

        const doc = new docx.Document({
          sections: sections.map(section => ({
            properties:{
              page:{
                size:{
                  width: docx.convertInchesToTwip(section.width),
                  height: docx.convertInchesToTwip(section.height)
                },
                margin:{ top:0, right:0, bottom:0, left:0 }
              }
            },
            children:[
              new docx.Paragraph({
                children:[
                  new docx.ImageRun({
                    data: section.data,
                    transformation:{
                      width: docx.convertInchesToTwip(section.width),
                      height: docx.convertInchesToTwip(section.height)
                    }
                  })
                ]
              })
            ]
          }))
        });

        const blob = await docx.Packer.toBlob(doc);
        return {
          name: entry.name.replace(/\.pdf$/i,"") + ".docx",
          blob,
          note: `${sections.length} trang, nhúng ảnh toàn trang`
        };
      };

      const convert = async () => {
        if(state.converting || !state.files.length){
          return;
        }
        if(!pdfjs || !docx || !JSZipLib || typeof saveFile !== "function"){
          setStatus("Thiếu thư viện cần thiết. Vui lòng tải lại trang.", "error");
          return;
        }

        closeOptionsPanel();
        state.converting = true;
        convertBtn.disabled = true;
        progressWrap.style.display = "flex";
        progressBar.style.width = "0%";
        progressLabel.textContent = "Đang chuẩn bị...";
        setStatus("Đang chuyển đổi, vui lòng chờ...", "info");
        downloads = [];
        renderDownloads();

        try{
          const results = [];
          for(let index=0; index<state.files.length; index++){
            const entry = state.files[index];
            const result = await buildDocxFromImages(entry);
            results.push(result);
            const percent = Math.round(((index+1) / state.files.length) * 100);
            progressBar.style.width = percent + "%";
          }

          if(results.length === 1){
            downloads = results;
          }else{
            const archive = new JSZipLib();
            results.forEach(item => archive.file(item.name, item.blob));
            const zipBlob = await archive.generateAsync({ type:"blob" });
            downloads = [{
              name: `pdf-sang-word-${Date.now()}.zip`,
              blob: zipBlob,
              note: `${results.length} tài liệu DOCX`
            }, ...results];
          }
          renderDownloads();

          if(downloads[0]){
            saveFile(downloads[0].blob, downloads[0].name);
          }
          setStatus("Hoàn tất! Tệp Word đã sẵn sàng tải xuống.", "success");
        }catch(error){
          console.error(error);
          setStatus("Đã xảy ra lỗi khi chuyển đổi. Vui lòng thử lại.", "error");
        }finally{
          state.converting = false;
          convertBtn.disabled = !state.files.length;
          progressWrap.style.display = "none";
          progressBar.style.width = "0%";
          progressLabel.textContent = "Đang chuẩn bị...";
        }
      };

      convertBtn.addEventListener("click", convert);

      window.addEventListener("keydown", evt => {
        if((evt.ctrlKey || evt.metaKey) && evt.key.toLowerCase() === "o"){
          evt.preventDefault();
          fileInput.click();
        }
        if(evt.key === "Escape" && aside.classList.contains("open")){
          closeOptionsPanel();
        }
      });

      renderFiles();
      renderDownloads();
    })();
  </script>
</body>
</html>
